# 摘要
　　串接的目標在於簡化問題，當問題具有多重目標時，將其拆解並進行串接可能是一個不錯的解決方案。然而，對於能夠用單一模型解決的問題，拆分反而可能失去意義。有時，我們真正需要的或許是重新定義問題，而不是將其過度拆解。
# 串接
　　類似於分治法 (Divide and Conquer) 的概念，將一個問題拆解成許多更小的問題來解決，然後將負責不同問題的模型進行串接。進一步說，「串接」，就是機器學習問題的一個模型的輸出是下一個模型的輸入，或是會決定後續的模型的選擇。
## 問題
### 情境
　　假設我們現在有的資料集資料極度不平衡，我們需要模型能夠對大多數的情況表現出良好的預測能力，但是我們同時也需要模型能在少數的情況中表現良好。並且，我們想要捕捉的目標在這兩種情況中表現出了截然不同的型態。
　　因此，這個任務可以分為兩個關鍵點：首先，模型需要能夠準確區分當前情境屬於哪一類；其次，模型必須能夠在不同的情境下，針對各自的目標進行精確的捕捉與預測。換句話說，在這個任務裡我們實際上有複合的目標。
　　最直接的反應是平衡資料，透過過採樣或下採樣來處理不平衡。然而，這並不能真正解決資料偏斜的問題。平衡資料雖能暫時解決數量上的不對稱，但對於資料間潛在的特徵差異並沒有幫助。此外，平衡資料的過程實際上是在改變原始資料的分布，而這恰好是我們想要保留並加以分析的部分。資料的原始分布很可能蘊含了我們希望捕捉的關鍵行為模式，因此平衡資料並非最佳解法。
　　那麼，我們該怎麼做呢？
## 解決方案
### 為什麼要串接？
　　儘管實務上有多種模型能夠滿足這樣的需求，然而最簡單的方法是直接將任務拆分，然後對模型進行串接。
　　我們可以先訓練一個模型，在這個模型訓練前，我們先採用曾在 [[[Day 6]　設計模式：重新平衡 (Rebalancing)]] 討論過的方法，訓練一個預測是否為罕見情況的模型。然後我們再對兩種情境分別做訓練，罕見情況就丟進罕見情況的模型訓練，常見的就丟進常見的裡，讓兩個模型各自學習各自情境的特徵。
　　那麼新的問題來了，如果第一個模型的結果是錯誤的呢？
### 怎麼盡可能確保下游的模型的輸入特徵會是正確的？
　　如果第一個模型誤判情境，將錯誤的資料傳遞給下游模型，可能會導致預測結果不準確。這是串接模型的一個潛在風險。為了應對這個問題，在訓練過程中，我們不能僅僅將資料按照預定的類型（罕見或常見）直接分配到各自的模型中進行訓練。反之，我們需要讓上游模型的輸出成為訓練資料的一部分，這樣模型在學習過程中會自動適應這種分類錯誤的情況。
　　具體來說，我們可以讓下游的模型接收來自上游模型的輸出作為一個額外的特徵，並進行聯合訓練。這樣，即使上游模型的預測存在偏差，下游模型也能根據這些偏差調整其預測行為，從而提高整體的預測準確性。
### 評估與預測
　　因此，我們不僅要關注最終的輸出結果，更要確保每個模型在流程中的表現都盡可能準確無誤。這意味著，我們在評估系統的時候，不能僅針對最終模型進行評估，而是要分別評估所有參與的模型。具體而言，這包括上游的分類模型，以及後續專門處理不同情境（如罕見和常見情況）的兩個模型。只有確保這三個模型各自的表現都達到標準，我們才能保證整體流程的準確性和穩定性。
### Workflow Pipline
　　在實務應用中，我們通常不會將每個模型分開訓練，而是更常透過建立 Pipeline 來自動化整體工作流程。關於這個框架的細節我們將在明天進一步討論。不過，目前可以說明的是，結合這樣的框架後，Cascade 設計模式將更方便應用於多種場景。透過這種方式，當上游模型進行更新或調整時，下游模型也會自動重新訓練，確保整個系統的一致性。同時，這也有助於保留每次訓練的歷史記錄，便於後續的分析和回溯。
　　一些提供這類框架的工具包括 Kubeflow Pipelines。如果我們使用 TFX (TensorFlow Extended) 作為框架，得益於它的集成性，不需要專門部署上游模型來獲取其輸出以供下游使用。反之，我們可以採用後天將介紹的 Transform 設計模式，將上游模型的輸出作為預處理的一部分，進一步簡化流程並提升系統效率。。
## 代價
### 複雜性
　　儘管使用管道／實驗框架必定會是最好的解決方案，但是 Cascade 設計模式並不一定會是最佳解，有可能反而因此更複雜——正如我們在一開始介紹這個方法時提到的，我們選擇這個方法是為了簡化模型的設計與部分工作流程。因此我們必須審慎評估，確認這個方法確實能降低我們的負擔。
### 確定性的輸入
　　如果這兩種情境可以通過明確的特徵來直接區分，而不需要依賴模型去判斷資料屬於哪種情境，那麼救應該直接根據這些特徵進行分類，而不是嘗試訓練模型來捕捉這些特徵。
　　能夠從潛在特徵或多個特徵中確認的也是，只要能用一個模型輕易解決，那麼拆分它就不會是一個好方法。
# 替代方案
## Reframing
　　正如前面所說的，只要一個模型就能輕鬆解決，那麼就不應該拆分它。有些時候，如果覺得已經面臨不得不拆分問題的場景，說不定可以嘗試修改問題的定義。關於這個解決方案，我們已在 [[[Day 15]　設計模式：重新定位 (Reframing)]] 說明。
# 參考資料
- Machine Learning Design Patterns: Solutions to Common Challenges in Data Preparation, Model Building, and MLOps CH3 Design Pattern: Cascade